name: Update Dependencies

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 3 * * 1'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-deps:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Update dependencies
        run: |
          # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
          pnpm update --latest

      - name: Check if there are changes
        id: git-check
        run: |
          git status --porcelain
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ“¦ Update dependencies'
          title: 'ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°'
          body: |
            ## ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å®šæœŸæ›´æ–°

            ã“ã®PRã¯ã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
            ä»¥ä¸‹ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

            - `package.json`ã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ
            - `pnpm-lock.yaml`ãŒå†ç”Ÿæˆã•ã‚Œã¾ã—ãŸ

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆ
            - CI/CDãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
            - äº’æ›æ€§ã®å•é¡ŒãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„

            ã“ã®PRã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
          branch: update-dependencies
          base: main
          delete-branch: true
          labels: |
            dependencies
            automated pr
